function FeedHandler(a){this._webSocketConnection=null,this._symbolRequestResponseHandler=null,this._ohlcRequestResponseHandler=null,this._tickDataRequestResponseHandler=null,this._isConnectionReady=!1,this._db=null,this._lastTickTime=null,this.init()}Datafeeds={},Datafeeds.UDFCompatibleDatafeed=function(){this._configuration=void 0,this._symbolSearch=null,this._symbolsStorage=null,this._enableLogging=!1,this._initializationFinished=!1,this._callbacks={},this._feedHandler=new FeedHandler,this._supported_resolutions=[];for(var a=1;59>=a;a++)this._supported_resolutions.push(""+a);for(var a=1;23>=a;a++)this._supported_resolutions.push(""+60*a);this._supported_resolutions.push("D");for(var a=2;3>=a;a++)this._supported_resolutions.push(a+"D");this._initialize()},Datafeeds.UDFCompatibleDatafeed.prototype.defaultConfiguration=function(){return{supports_search:!0,supports_group_request:!1,supported_resolutions:["1","3","5","15","30","45","60","120","180","240","D","2D","3D"],supports_marks:!0,exchanges:[],symbolsTypes:[{name:"Randoms",value:"Random"},{name:"Commodities",value:"Commodities"},{name:"Forex",value:"Forex"},{name:"Stocks",value:"Stocks"},{name:"Indices",value:"Indices"}]}},Datafeeds.UDFCompatibleDatafeed.prototype.on=function(a,b){return this._callbacks.hasOwnProperty(a)||(this._callbacks[a]=[]),this._callbacks[a].push(b),this},Datafeeds.UDFCompatibleDatafeed.prototype._fireEvent=function(a,b){if(this._callbacks.hasOwnProperty(a)){for(var c=this._callbacks[a],d=0;d<c.length;++d)c[d](b);this._callbacks[a]=[]}},Datafeeds.UDFCompatibleDatafeed.prototype.onInitialized=function(){this._initializationFinished=!0,this._fireEvent("initialized")},Datafeeds.UDFCompatibleDatafeed.prototype._logMessage=function(a){if(this._enableLogging){new Date}},Datafeeds.UDFCompatibleDatafeed.prototype._initialize=function(){this._feedHandler._symbolRequestResponseHandler.getSymbolTypeList();var a=this;$(document).one("marketsLoaded",function(){var b=a.defaultConfiguration();b.symbolsTypes=[];var c=a._feedHandler._symbolRequestResponseHandler.getSymbolTypeList();for(var d in c)b.symbolsTypes.push({name:c[d],value:c[d]});a._setupWithConfiguration(b)})},Datafeeds.UDFCompatibleDatafeed.prototype.onReady=function(a){if(this._configuration)a(this._configuration);else{var b=this;this.on("configuration_ready",function(){a(b._configuration)})}},Datafeeds.UDFCompatibleDatafeed.prototype._setupWithConfiguration=function(a){this._configuration=a,a.exchanges||(a.exchanges=[]);var b=a.supported_resolutions||a.supportedResolutions;a.supported_resolutions=b;var c=a.symbols_types||a.symbolsTypes;if(a.symbols_types=c,!a.supports_search&&!a.supports_group_request)throw"Unsupported datafeed configuration. Must either support search, or support group request";a.supports_search||(this._symbolSearch=new Datafeeds.SymbolSearchComponent(this)),a.supports_group_request?this._symbolsStorage=new Datafeeds.SymbolsStorage(this):this.onInitialized(),this._fireEvent("configuration_ready"),this._logMessage("Initialized with "+JSON.stringify(a))},Datafeeds.UDFCompatibleDatafeed.prototype._symbolMetadata=function(a){var b={};if(a){var c=1e4,d=1,e="2200-2159:123456";"Forex"==a?c=1e5:"Random"==a&&(e="24x7"),b={pricescale:c,minmov:d,session:e}}return b},Datafeeds.UDFCompatibleDatafeed.prototype.searchSymbolsByName=function(a,b,c,d){function e(a){var b=[];return $.each(f._feedHandler._symbolRequestResponseHandler._markets,function(d,e){$.each(e.submarkets,function(d,g){$.each(g.symbols,function(d,g){-1!=e.name.indexOf(c)&&(-1!=g.symbol.indexOf(a)||-1!=g.symbol_display.indexOf(a))&&b.push({symbol:g.symbol,description:g.symbol_display,type:e.name,exchange:"",full_name:g.symbol,supported_resolutions:f._supported_resolutions})})})}),b}if(!this._configuration)return void d([]);if(this._configuration.supports_search){var f=this;d(e(a))}},Datafeeds.UDFCompatibleDatafeed.prototype.resolveSymbol=function(a,b,c){function d(a){var c=a;e.postProcessSymbolInfo&&(c=e.postProcessSymbolInfo(c)),b(c)}var e=this;if(!this._initializationFinished)return void this.on("initialized",function(){e.resolveSymbol(a,b,c)});if(this._configuration.supports_group_request)this._initializationFinished?this._symbolsStorage.resolveSymbol(a,d,c):this.on("initialized",function(){e._symbolsStorage.resolveSymbol(a,d,c)});else{var f=!1;$.each(e._feedHandler._symbolRequestResponseHandler._markets,function(b,c){return $.each(c.submarkets,function(b,g){return $.each(g.symbols,function(b,g){if(-1!=g.symbol.indexOf(a)){var h=e._symbolMetadata(c.name),i=h.pricescale,j=h.minmov,k=h.session;return d({name:g.symbol,timezone:"UTC",has_intraday:!0,has_no_volume:!0,ticker:g.symbol,description:g.symbol_display,type:c.name,minmov:j,pricescale:i,supported_resolutions:e._supported_resolutions,session:k}),f=!0,!1}}),!f}),!f}),f||c("unknown_symbol")}},Datafeeds.UDFCompatibleDatafeed.prototype.getBars=function(a,b,c,d,e,f){try{$(document).trigger("chart-status-picture-change",["loading"]),this._feedHandler._ohlcRequestResponseHandler.resetTableData(a),this._feedHandler._ohlcRequestResponseHandler.getBars(a,c,d,e,f)}catch(g){}},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeBars=function(a,b,c,d){this._feedHandler._tickDataRequestResponseHandler.subscribeBars(a,c,d)},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeBars=function(a){this._feedHandler._tickDataRequestResponseHandler.unsubscribeBars(a)},Datafeeds.UDFCompatibleDatafeed.prototype.getMarks=function(a,b,c,d,e){},Datafeeds.UDFCompatibleDatafeed.prototype.calculateHistoryDepth=function(a,b,c){},Datafeeds.UDFCompatibleDatafeed.prototype.getQuotes=function(a,b,c){},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeQuotes=function(a,b,c,d){},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeQuotes=function(a){},Datafeeds.SymbolsStorage=function(a){this._datafeed=a,this._symbolsInfo={},this._symbolsList=[],this._requestFullSymbolsList()},Datafeeds.SymbolsStorage.prototype._requestFullSymbolsList=function(){var a=this,b=this._datafeed;$.each(a._feedHandler._symbolRequestResponseHandler._markets,function(c,d){$.each(d.submarkets,function(c,e){$.each(e.symbols,function(c,e){var f=b._symbolMetadata(d.symbol),g=f.pricescale,h=f.minmov,i=f.session,j={name:e.symbol,base_name:e.symbol,description:e.symbol_display,full_name:e.symbol,legs:[e.symbol],has_intraday:!0,has_no_volume:!0,listed_exchange:[],exchange:[""],minmov:h,pricescale:g,type:d.name,session:i,ticker:e.symbol,timezone:"UTC",supported_resolutions:a._supported_resolutions,has_daily:!0,has_fractional_volume:!1,has_weekly_and_monthly:!0,has_empty_bars:!1,volume_precision:0};a._symbolsInfo[e.symbol]=a._symbolsInfo[e.display_name]=j,a._symbolsList.push(e.symbol)})})}),this._symbolsList.sort(),this._datafeed.onInitialized()},Datafeeds.SymbolsStorage.prototype.resolveSymbol=function(a,b,c){this._symbolsInfo.hasOwnProperty(a)?b(this._symbolsInfo[a]):c("invalid symbol")},Datafeeds.SymbolSearchComponent=function(a){this._datafeed=a},Datafeeds.SymbolSearchComponent.prototype.searchSymbolsByName=function(a,b){if(!this._datafeed._symbolsStorage)throw"Cannot use local symbol search when no groups information is available";for(var c=this._datafeed._symbolsStorage,d=[],e=!a.ticker||0===a.ticker.length,f=0;f<c._symbolsList.length;++f){var g=c._symbolsList[f],h=c._symbolsInfo[g];if(!(a.type&&a.type.length>0&&h.type!=a.type)&&((e||0===h.name.indexOf(a.ticker))&&d.push({symbol:h.name,full_name:h.full_name,description:h.description,exchange:h.exchange,params:[],type:h.type,ticker:h.name,supported_resolutions:this._datafeed._supported_resolutions}),d.length>=b))break}a.onResultReadyCallback(d)},FeedHandler.prototype.close=function(){this._webSocketConnection&&this._webSocketConnection.close()},FeedHandler.prototype.init=function(){this._webSocketConnection=new ReconnectingWebSocket("wss://www.binary.com/websockets/v2"),this._db=new loki,this._db.addCollection("bars_key_table"),this._db.addCollection("bars_table"),this._symbolRequestResponseHandler=new SymbolRequestResponsehandler(this),this._ohlcRequestResponseHandler=new OHLCRequestResponseHandler(this),this._tickDataRequestResponseHandler=new TickDataRequestResponseHandler(this),this._webSocketConnection.debug=!1,this._webSocketConnection.timeoutInterval=5400,this._webSocketConnection.onopen=function(a){this._isConnectionReady=!0,$(document).trigger("websocketsConnectionReady")},this._webSocketConnection.onerror=function(a){this._isConnectionReady=!1};var a=this;this._webSocketConnection.onmessage=function(b){var c=JSON.parse(b.data);switch(c.msg_type){case"trading_times":a._symbolRequestResponseHandler.process(c);break;case"candles":a._ohlcRequestResponseHandler.process(c);break;case"tick":if(c.tick.error)$(document).trigger("chart-status-picture-change",["delayed-feed"]),a._lastTickTime=null;else if(c.echo_req.tradingview_ticker_id){var d=TradingView.currentlyDisplayedSymbol+TradingView.actualResolution;d==c.echo_req.tradingview_ticker_id?(a._lastTickTime=Date.now(),$(document).trigger("chart-status-picture-change",["realtime-feed"]),a._tickDataRequestResponseHandler.process(c)):a._webSocketConnection.send(JSON.stringify({forget:c.tick.id}))}}},setInterval(function(){if(a._lastTickTime){var b=Date.now()-a._lastTickTime;b>=6e4&&($(document).trigger("chart-status-picture-change",["no-connection"]),a._tickDataRequestResponseHandler&&a._tickDataRequestResponseHandler.reSubscribeToTicks())}},6e4)},OHLCRequestResponseHandler=function(a){this.feedHandler=a,this._barsKeyTable={},this._barsTable={},this.init()},OHLCRequestResponseHandler.prototype.init=function(){this._barsKeyTable=this.feedHandler._db.getCollection("bars_key_table"),this._barsTable=this.feedHandler._db.getCollection("bars_table"),this.requestParameters=function(a,b){var c=this.parseSuffixAndIntValue(),d=c.suffix,e=c.intVal,f=this.totalSecondsInABar(d,e),g=Math.ceil((b-a)/f);return{suffix:d,intVal:e,count:g,totalSecondsInABar:f}},this.renderBars=function(a){var b=this._barsTable.chain().find({barsKeyTableID:a}).find({rendered:!1}).simplesort("time",!1).data(),c=this._barsKeyTable.findObject({barsKeyTableID:a}),d=c.onErrorCallback_chart,e=c.onDataCallback_chart,f=[];for(var g in b){var h=b[g];f.push({time:h.time,open:h.open,high:h.high,low:h.low,close:h.close}),h.rendered=!0}if(b&&b.length>0&&(b[b.length-1].rendered=!1),this._barsTable.update(b),0==f.length&&d)d("no data");else if(e)if(d)e(f);else for(var g in f)e(f[g])}},OHLCRequestResponseHandler.prototype.parseSuffixAndIntValue=function(){var a=TradingView.actualResolution.toUpperCase().replace("D","").replace("M","").replace("W",""),b=""==a?1:parseInt(a),c=TradingView.actualResolution.replace(""+b,"");switch(c){case"":60>b?c="M":(b/=60,c="H");break;case"W":b*=7,c="D";break;case"M":b*=30,c="D"}return{suffix:c,intVal:b}},OHLCRequestResponseHandler.prototype.totalSecondsInABar=function(a,b){var c=0;switch(a){case"M":c=60*b;break;case"H":c=60*b*60;break;case"D":c=24*b*60*60}return c},OHLCRequestResponseHandler.prototype.getBars=function(a,b,c,d,e){if(b>0&&(b+"").length>10)throw"Got a JS time instead of Unix one.";var f=this._barsKeyTable.findObject({key:a.ticker+TradingView.actualResolution})||{},g=f.barsKeyTableID||-1;-1==g?(g=(new Date).getTime(),this._barsKeyTable.insert({barsKeyTableID:g,key:a.ticker+TradingView.actualResolution,onErrorCallback_chart:e,onDataCallback_chart:d}),f=this._barsKeyTable.findOne({barsKeyTableID:g})):(f.onDataCallback_chart=d,f.onErrorCallback_chart=e,this._barsKeyTable.update(f));var h=this.requestParameters(b,c),i=h.suffix,j=h.intVal,k=h.count,l=h.totalSecondsInABar;if(this._barsTable.findObject({barsKeyTableID:g})){var m=this._barsTable.chain().find({barsKeyTableID:g}).simplesort("time",!1).limit(1).data()[0],n=m.time/1e3;n>b&&(c=n)}k>500&&(b=c-450*l);var o=Math.floor((new Date).getTime()/1e3-94608e3);o>b&&(b=o),c+=l;var p={ticks:a.ticker,start:b,end:c,granularity:i+j,adjust_start_time:1};this.feedHandler._webSocketConnection.send(JSON.stringify(p))},OHLCRequestResponseHandler.prototype.process=function(a){if(a.candles){var b=a.candles,c=this._barsKeyTable.findObject({key:a.echo_req.ticks+TradingView.actualResolution})||{},d=c.barsKeyTableID||-1;for(var e in b){var f=b[e],g=1e3*parseInt(f.epoch),h=parseFloat(f.open),i=parseFloat(f.high),j=parseFloat(f.low),k=parseFloat(f.close),l=this._barsTable.chain().find({barsKeyTableID:d}).find({time:g}).limit(1).data();l.length<=0?this._barsTable.insert({barsKeyTableID:d,time:g,open:h,high:i,low:j,close:k,rendered:!1}):(l[0].open=h,l[0].high=i,l[0].low=j,l[0].close=k,this._barsTable.update(l))}this.renderBars(d),$(document).trigger("barsLoaded")}},OHLCRequestResponseHandler.prototype.resetTableData=function(a){var b=this._barsKeyTable.findObject({key:a.ticker+TradingView.actualResolution})||{},c=b.barsKeyTableID||-1,d=this._barsTable.chain().find({barsKeyTableID:c}).data()||[];for(var e in d)d[e].rendered=!1;this._barsTable.update(d)},SymbolRequestResponsehandler=function(a){this._markets=null,this._symbolTypes=null,this._currentlyProcessingRequest=!1,this.fetchSymbolListAndInformation=function(){this._markets?this._currentlyProcessingRequest=!1:this._currentlyProcessingRequest||a._webSocketConnection&&(this._currentlyProcessingRequest=!0,a._isConnectionReady?a._webSocketConnection.send(JSON.stringify({trading_times:""+(new Date).toISOString().slice(0,10)})):$(document).one("websocketsConnectionReady",function(){a._webSocketConnection.send(JSON.stringify({trading_times:""+(new Date).toISOString().slice(0,10)}))}))}},SymbolRequestResponsehandler.prototype.getSymbolTypeList=function(){return this.fetchSymbolListAndInformation(),this._symbolTypes},SymbolRequestResponsehandler.prototype.getSymbolList=function(){return this.fetchSymbolListAndInformation(),this.markets},SymbolRequestResponsehandler.prototype.process=function(a){this._markets=[],this._symbolTypes=[];for(var b in a.trading_times.markets){var c=a.trading_times.markets[b];this._symbolTypes.push(c.name);var d={name:c.name,submarkets:[]};for(var e in c.submarkets){var f=c.submarkets[e],g={name:f.name,symbols:[]};for(var h in f.symbols){var i=f.symbols[h];g.symbols.push({symbol:i.symbol,symbol_display:i.name})}d.submarkets.push(g)}this._markets.push(d)}$(document).trigger("marketsLoaded"),this._currentlyProcessingRequest=!1},TickDataRequestResponseHandler=function(a){this.feedHandler=a,this._barsKeyTable={},this._barsTable={},this.init()},TickDataRequestResponseHandler.prototype.init=function(){this._barsKeyTable=this.feedHandler._db.getCollection("bars_key_table"),this._barsTable=this.feedHandler._db.getCollection("bars_table")},TickDataRequestResponseHandler.prototype.process=function(a){var b=this._barsKeyTable.findObject({key:a.echo_req.ticks+TradingView.actualResolution});if(b){var c=this._barsTable.chain().find({barsKeyTableID:b.barsKeyTableID}).simplesort("time",!0).limit(1).data();if(c&&!(c.length<=0)&&(c=c[0],!(c.time<parseInt(a.tick.epoch)))){var d=parseFloat(a.tick.quote);d>c.high?c.high=d:d<c.low&&(c.low=d),c.close=d,c.rendered=!1,b.onRealtimeCallback_chart&&(this._barsTable.update(c),b.onRealtimeCallback_chart({time:c.time,open:c.open,high:c.high,low:c.low,close:c.close}))}}},TickDataRequestResponseHandler.prototype.subscribeBars=function(a,b,c){var d=this._barsKeyTable.findObject({key:a.ticker+TradingView.actualResolution});if(d&&!d.listenerGUID){d.onRealtimeCallback_chart=b,d.listenerGUID=c,this.feedHandler._webSocketConnection.send(JSON.stringify({ticks:a.ticker,tradingview_ticker_id:a.ticker+TradingView.actualResolution}));var e=this._barsTable.chain().find({barsKeyTableID:d.barsKeyTableID}).simplesort("time",!0).limit(1).data()[0],f=this.feedHandler._ohlcRequestResponseHandler.parseSuffixAndIntValue(),g=this.feedHandler._ohlcRequestResponseHandler.totalSecondsInABar(f.suffix,f.intVal),h=new Date(e.time+1e3*g),i=new Date,j=this;d.timerHandler=setTimeout(function(){function c(){e=j._barsTable.chain().find({barsKeyTableID:d.barsKeyTableID}).simplesort("time",!0).limit(1).data(),e&&e.length>0&&(e=e[0],j.feedHandler._ohlcRequestResponseHandler.getBars(a,e.time/1e3,(new Date).getTime()/1e3+g,b))}d.timerHandler=setInterval(function(){c()},1e3*g),c(),j._barsKeyTable.update(d)},Math.ceil(h.getTime()-i.getTime())+1e3),this._barsKeyTable.update(d)}},TickDataRequestResponseHandler.prototype.unsubscribeBars=function(a){var b=this._barsKeyTable.findObject({listenerGUID:a});if(b){try{clearInterval(b.timerHandler)}catch(c){}try{clearTimeout(b.timerHandler)}catch(c){}b.onErrorCallback_chart=null,b.onDataCallback_chart=null,b.listenerGUID=null,b.onRealtimeCallback_chart=null,this._barsKeyTable.update(b)}},TickDataRequestResponseHandler.prototype.reSubscribeToTicks=function(){var a=this._barsKeyTable.findObjects({});if(a){for(var b in a){var c=a[b];if(c){var d=c.key.replace(TradingView.actualResolution,"").trim();this.feedHandler._webSocketConnection.send(JSON.stringify({ticks:d,tradingview_ticker_id:c.key}))}}this._barsKeyTable.update(a)}};